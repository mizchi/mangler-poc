import fs from "fs/promises";
import path from "path";
import {
  getDomReserved,
  getTerserDompropsReserved,
  getWorkerReserved,
  getEsReserved
} from "../lib/precollect.mjs";
import { httpHeaders } from "../gen/httpHeaders.mjs";

function getHttpHeadersReserved() {
  return [
    ...httpHeaders,
    ...httpHeaders.map((header) => header.toLowerCase()),
    ...httpHeaders.map((header) => header.toUpperCase()),
  ]
}

const __dirname = path.dirname(new URL(import.meta.url).pathname);
export async function dumpReservedWords(){
  const tsPath = path.join(__dirname, '../../node_modules/typescript/lib/typescript.js');
  const terserMainPath = path.join(__dirname, '../node_modules/terser/dist/bundle.min.js');
  const tsLibDir = path.dirname(tsPath);
  const dompropsReserved = await getTerserDompropsReserved(terserMainPath);
  const domReserved = await getDomReserved(tsLibDir);
  const workerReserved = await getWorkerReserved(tsLibDir);
  const esReserved = await getEsReserved(tsLibDir);

  const httpHeadersReserved = getHttpHeadersReserved();

  console.log("domprops", dompropsReserved.size);
  console.log("esReserved.size", esReserved.size);
  console.log("domReserved.size", domReserved.size);
  console.log("workerReserved.size", workerReserved.size);
  console.log("httpHeadersReserved.size", httpHeadersReserved.length);

  const output = `// generated by optools
export const domprops = ${JSON.stringify([...dompropsReserved].sort(), null, 2)};
export const es = ${JSON.stringify([...esReserved].sort(), null, 2)};
export const dom = ${JSON.stringify([...domReserved].sort(), null, 2)};
export const worker = ${JSON.stringify([...workerReserved].sort(), null, 2)};
export const httpHeaders = ${JSON.stringify([...httpHeadersReserved].sort(), null, 2)};
`;
  await fs.writeFile(path.join(__dirname, '../gen/builtins.mjs'), output);
}

await dumpReservedWords();